FROM ubuntu:23.04 as base
RUN apt-get update && apt-get install -y curl unzip
RUN curl -fsSL https://bun.sh/install | bash
WORKDIR /app
ARG HOST_NAME
ARG CLIENT_PORT
ARG SERVER_PORT
ARG DATABASE_URL
ARG DATABASE_AUTH_TOKEN
ARG LOCAL_SQLITE_DB_NAME
ENV HOME=/root
ENV BUN_INSTALL=$HOME/.bun
ENV PATH=$BUN_INSTALL/bin:$PATH
ENV VITE_HOST_NAME=$HOST_NAME
ENV VITE_CLIENT_PORT=$CLIENT_PORT
ENV VITE_SERVER_PORT=$SERVER_PORT
ENV DATABASE_URL=$DATABASE_URL
ENV DATABASE_AUTH_TOKEN=$DATABASE_AUTH_TOKEN
ENV LOCAL_SQLITE_DB_NAME=$LOCAL_SQLITE_DB_NAME
ENV NODE_ENV=production
COPY .env .
COPY apps/server/ .

RUN bun install
RUN bun scripts/migrate.ts
RUN bun run build

FROM oven/bun:latest as runner
WORKDIR /app
ARG SERVER_PORT
ARG CLIENT_PORT
ARG HOST_NAME
ARG LOCAL_SQLITE_DB_NAME
ENV VITE_SERVER_PORT=$SERVER_PORT
ENV VITE_CLIENT_PORT=$CLIENT_PORT
ENV VITE_HOST_NAME=$HOST_NAME
ENV NODE_ENV=production
COPY --from=base /app/.env .
COPY --from=base /app/dist/index.js .
COPY --from=base  /app/$LOCAL_SQLITE_DB_NAME .
COPY --from=base /app/Dockerfile .
CMD bun index.js
EXPOSE $SERVER_PORT:$SERVER_PORT
